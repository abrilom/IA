name: Ansible Playbook Runner

on:
  workflow_dispatch:

jobs:
  run_ansible_playbook:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Ansible and Ansible Lint
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-apt
          pip3 install ansible ansible-lint sshpass

      - name: Create Ansible inventory file
        run: |
          mkdir -p ansible
          echo "[local]" > ansible/inventory
          echo "localhost ansible_connection=local" >> ansible/inventory

      - name: Create Ansible playbook file
        run: |
          echo '
---
- name: Instalar y configurar Apache en Ubuntu con puerto 8080
  hosts: all
  become: true

  tasks:
    - name: Actualizar el índice de paquetes apt
      ansible.builtin.apt:
        update_cache: true

    - name: Instalar el paquete apache2
      ansible.builtin.apt:
        name: apache2
        state: present

    - name: Crear archivo de configuración de Apache para el puerto 8080
      ansible.builtin.template:
        src: templates/apache_8080.conf.j2
        dest: /etc/apache2/sites-available/000-default_8080.conf
        owner: root
        group: root
        mode: \'0644\'
      notify:
        - Validar y Reiniciar Apache

    - name: Habilitar el sitio de Apache para el puerto 8080
      ansible.builtin.command: a2ensite 000-default_8080.conf
      args:
        creates: /etc/apache2/sites-enabled/000-default_8080.conf
      notify:
        - Validar y Reiniciar Apache

    - name: Deshabilitar el sitio de Apache por defecto (puerto 80)
      ansible.builtin.command: a2dissite 000-default.conf
      args:
        removes: /etc/apache2/sites-enabled/000-default.conf
      notify:
        - Validar y Reiniciar Apache

  handlers:
    - name: Validar y Reiniciar Apache
      listen: Validar y Reiniciar Apache
      block:
        - name: Validar la configuración de Apache
          ansible.builtin.command: apache2ctl configtest
          register: apache_config_test
          changed_when: false
          failed_when: apache_config_test.rc != 0

        - name: Reiniciar el servicio apache2
          ansible.builtin.service:
            name: apache2
            state: restarted
' > ansible/playbook.yml

      - name: Create Ansible template file
        run: |
          mkdir -p ansible/templates
          echo '
<VirtualHost *:8080>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    ErrorLog ${APACHE_LOG_DIR}/error_log
    CustomLog ${APACHE_LOG_DIR}/access_log combined

    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>
</VirtualHost>
' > ansible/templates/apache_8080.conf.j2

      - name: Run Ansible Lint
        run: ansible-lint ansible/playbook.yml

      - name: Run Ansible Playbook
        run: |
          ansible-playbook ansible/playbook.yml -i ansible/inventory -e "ansible_ssh_pass=${{ secrets.ANSIBLE_SSH_PASS }}" --ssh-extra-args='-o StrictHostKeyChecking=no'
